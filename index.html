<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>FNF TXT Engine</title>
<style>
body { margin:0; background:#111; color:#fff; font-family:sans-serif; }
#game { width:100vw; height:100vh; position:relative; overflow:hidden; }
.note { width:80px; height:20px; position:absolute; background:#4af; border-radius:4px; }
.lane0 { left:10vw; } .lane1 { left:30vw; } .lane2 { left:50vw; } .lane3 { left:70vw; }
#loader { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:24px; }
</style>
</head>
<body>
<div id="game"><div id="loader">Loading…</div></div>

<script>
async function loadTXT(path){
  const res = await fetch(path);
  return await res.text();
}

let chart = [];
let audioData = null;
let bgData = null;
let bpm = 120;
let offset = 0;

function parseChart(txt){
  const lines = txt.split("\n");
  for(const line of lines){
    if(line.startsWith("BPM:")) bpm = parseFloat(line.split(":")[1]);
    else if(line.startsWith("OFFSET:")) offset = parseFloat(line.split(":")[1]);
    else if(line.match(/^[0-9]/)){
      const [time, lane, type, length] = line.split(" ");
      chart.push({ time:parseFloat(time), lane:parseInt(lane), type, length:parseFloat(length) });
    }
  }
}

async function parseAssets(txt){
  const lines = txt.split("\n");
  for(const line of lines){
    if(line.startsWith("AUDIO:")) audioData = line.replace("AUDIO:","").trim();
    if(line.startsWith("IMAGE:")) bgData = line.replace("IMAGE:","").trim();
  }
}

function createAudio(base64){
  const audio = new Audio(base64);
  audio.preload = "auto";
  return audio;
}

function setBackground(base64){
  const game = document.getElementById("game");
  game.style.backgroundImage = `url(${base64})`;
  game.style.backgroundSize = "cover";
  game.style.backgroundPosition = "center";
}

function parseMeta(txt){
  const lines = txt.split("\n");
  for(const line of lines){
    if(line.startsWith("TITLE:"))
      document.title = line.replace("TITLE:","").trim();
  }
}

let audio = null;
let startTime = 0;
let playing = false;

function spawnNotes(){
  const game = document.getElementById("game");
  for(const n of chart){
    const div = document.createElement("div");
    div.className = `note lane${n.lane}`;
    div.dataset.time = n.time;
    game.appendChild(div);
  }
}

function startGame(){
  audio = createAudio(audioData);
  setBackground(bgData);
  spawnNotes();

  audio.oncanplay = () => {
    startTime = performance.now() + offset;
    audio.play();
    playing = true;
    requestAnimationFrame(gameLoop);
  };
}

function gameLoop(now){
  if(!playing) return;
  const t = now - startTime;

  const notes = document.querySelectorAll(".note");
  for(const note of notes){
    const noteTime = parseFloat(note.dataset.time);
    const diff = noteTime - t;
    const y = diff * 0.3 + 400;
    note.style.top = y + "px";
    if(y > window.innerHeight) note.remove();
  }

  requestAnimationFrame(gameLoop);
}

async function loadMod(modName){
  const base = `mods/${modName}/`;

  const chartTXT = await loadTXT(base + "chart.txt");
  const audioTXT = await loadTXT(base + "audio.txt");
  const bgTXT    = await loadTXT(base + "bg.txt");
  const metaTXT  = await loadTXT(base + "meta.txt").catch(()=> "");

  parseChart(chartTXT);
  await parseAssets(audioTXT + "\n" + bgTXT);
  parseMeta(metaTXT);

  document.getElementById("loader").innerText = "Ready!";
  setTimeout(startGame, 500);
}

const params = new URLSearchParams(location.search);
const mod = params.get("mod");

if(mod){
  loadMod(mod);
}else{
  document.body.innerHTML = "<h1 style='color:white;text-align:center;margin-top:40vh;'>mod が指定されていません</h1>";
}
</script>
</body>
</html>
